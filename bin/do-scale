#!/bin/bash

. .setup_env

CLUSTER=`do-curl -X GET "https://api.digitalocean.com/v2/kubernetes/clusters" \
    | jq '.kubernetes_clusters[] | select(.name == "rinkeby")'`

#echo $CLUSTER | jq

CLUSTER_ID=`echo $CLUSTER | jq '.id' | tr -d '"'`
echo CLUSTER_ID=$CLUSTER_ID

NODE_POOL=`do-curl -X GET "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/node_pools" \
    | jq '.node_pools[] | select(.name == "prover") | {id: .id, name: .name, size: .size, count: .count}'`

echo NODE_POOL=$NODE_POOL

NODE_POOL_ID=`echo $NODE_POOL | jq '.id' | tr -d '"'`

echo NODE_POOL_ID=$NODE_POOL_ID

if [ -z $1 ]; then

R=`do-curl -X GET "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/node_pools/$NODE_POOL_ID"`

else

DATA='{"name": "prover", "count": '$1'}'
R=`do-curl -X PUT "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/node_pools/$NODE_POOL_ID" \
    --data "$DATA"`

fi

echo $R
echo $R | jq '.node_pool | {id: .id, name: .name, size: .size, count: .count, }'
echo nodes_running: `echo $R | jq '.node_pool | .nodes | length '`
