#!/bin/bash

set -e

# Force read env
ZKSYNC_ENV=
. .setup_env
cd core/lib/storage

echo DATABASE_URL=$DATABASE_URL
diesel database setup
diesel migration run

# We don't need this file for sqlx
rm src/schema.rs.generated

# Check generated sqlx data
if ! cargo sqlx prepare --check
then
    if [ -z $CI ]; then
        # It's not CI, just generate new bindings.
        # Prepare sqlx bindings
        echo "Going to rerun 'sqlx prepare'"
        cargo sqlx prepare
    else
        # It's CI and bindings are outdated.
        echo "'sqlx-data.json' in storagee folder is incorrect."
        echo "Generate and commit correct one with 'cargo sqlx prepare' in storage folder"
        exit 1
    fi
fi
