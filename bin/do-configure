#!/bin/bash
. .setup_env

# # Main cluster
# NAME=$CLUSTER_NAME
# CLUSTER=`echo $CLUSTERS | jq '.kubernetes_clusters | map(select(.name == "'$NAME'")) | .[0]'`
# CLUSTER_ID=`echo $CLUSTER | jq '.id' | tr -d '"' | grep -v null`
# CURRENT_COUNT=`echo $CLUSTER | jq '.node_pools[0] | .count' | grep -v null`
# NODE_POOL_ID=`echo $CLUSTER | jq '.node_pools[0] | .id' | grep -v null | tr -d '"'`
# DATA='{ "name": "prover", "count": 30}'
# echo $CLUSTER_ID $NODE_POOL_ID $DATA
# RET=`do-curl -X PUT "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/node_pools/$NODE_POOL_ID" --data "$DATA"`
# echo $RET

# . bin/.kube_gen_secret | kubectl apply -f - || exit 1
# kubectl apply -f etc/kube/prover.yaml || exit 1
# kubectl scale deployments/prover --replicas=$COUNT_PER_REGION || exit 1

PROVISIONED=0

CLUSTERS=`do-curl -X GET "https://api.digitalocean.com/v2/kubernetes/clusters"`
CLUSTERS_IDS=`echo $CLUSTERS | jq '.kubernetes_clusters | map(.id) | .[]'  | tr -d '"' | grep -v null`

mkdir -p etc/kube/clusters

echo "Target: $COUNT_PER_REGION per region"

for CLUSTER_ID in $CLUSTERS_IDS; do
    CLUSTER=`echo $CLUSTERS | jq '.kubernetes_clusters | map(select(.id == "'$CLUSTER_ID'")) | .[0]'`
    NAME=`echo $CLUSTER | jq '.name' | tr -d '"'`

    PROVER_POOL=`echo $CLUSTER | jq '.node_pools | map(select(.name == "prover")) | .[0]'`
    NODE_POOL_ID=`echo $PROVER_POOL | jq '.id' | grep -v null | tr -d '"'`
    CURRENT_COUNT=`echo $PROVER_POOL | jq '.count'`

    echo "Cluster $NAME, id = $CLUSTER_ID, NODE_POOL_ID = $NODE_POOL_ID, current_count = $CURRENT_COUNT"
    
    # DATA='{ "size": "c-32", "name": "prover", "count": '$COUNT_PER_REGION'}'
    # echo $DATA
    # RET=`do-curl -X PUT "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/node_pools/$NODE_POOL_ID" --data "$DATA"`
    # echo $RET

    KUBECONFIG=etc/kube/clusters/kubeconfig-$NAME.yaml
    do-curl -X GET "https://api.digitalocean.com/v2/kubernetes/clusters/$CLUSTER_ID/kubeconfig" > $KUBECONFIG

    bin/k8s-apply
    kubectl scale deployments/prover --replicas=$COUNT_PER_REGION

    # PROVISIONED=$((PROVISIONED + COUNT_PER_REGION))
    # if ((PROVISIONED >= COUNT_TOTAL)) 
    # then
    #     echo "provisioned $PROVISIONED, enough!"
    #     exit 0
    # fi
done

