#!/bin/bash

mkdir -p etc/kube/gen/$ZKSYNC_ENV
envsubst < etc/kube/server.yaml > etc/kube/gen/$ZKSYNC_ENV/server.yaml

# Generate and apply secret for env config
. bin/k8s-secret | kubectl apply -f -

# Apply cluster configuration
kubectl apply -f etc/kube/gen/$ZKSYNC_ENV/server.yaml
for BLOCK_SIZE_CHUNKS in $(echo $BLOCK_CHUNK_SIZES | sed "s/,/ /g"); do
    export BLOCK_SIZE_CHUNKS=$BLOCK_SIZE_CHUNKS
    envsubst < etc/kube/prover.yaml > etc/kube/gen/$ZKSYNC_ENV/prover.yaml
    kubectl apply -f etc/kube/gen/$ZKSYNC_ENV/prover.yaml
done
