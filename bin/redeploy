#!/bin/bash

cd `dirname $0`/..

if [ -z "$1" ]
then
    export ENV_FILE=local.env
else
    export ENV_FILE=$1.env
fi

if [ ! -f $ENV_FILE ]; then
    echo "no config file found: $1"
    exit
fi

set -o allexport
source $ENV_FILE
set +o allexport

echo redeploying for the db $DATABASE_URL

cd contracts
echo yarn deploy
yarn deploy  | tee ../deploy.log
cd ..

NEW_CONTRACT=`grep -A999 "Starting migrations" deploy.log | grep -A4 "Replacing 'PlasmaContract'" | grep "contract address" | grep -oE '0x(.+)' \
| sed -n "s/0x//p"`

if [ ! -z "$NEW_CONTRACT" ]
then
    echo New contract at $NEW_CONTRACT

    OLD_CONTRACT=`grep CONTRACT_ADDR ./$ENV_FILE | grep -oE '=(.+)' | sed -n "s/=//p"`
    echo Old contract at $OLD_CONTRACT

    sed -i"-`date +%Y-%m-%d-%H%M%S`.bak" "s/CONTRACT_ADDR=$OLD_CONTRACT/CONTRACT_ADDR=$NEW_CONTRACT/g" ./$ENV_FILE

    cd server/storage
    diesel database reset
    cd ../..
else
    echo "Contract deployment failed"
fi
