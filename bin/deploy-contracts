#!/bin/bash

. .setup_env

KEY_FILES=$CONTRACT_KEY_FILES
.load_keys

cp -f $KEY_DIR/*.sol contracts/contracts/keys/

echo redeploying for the db $DATABASE_URL

cd contracts
yarn deploy  | tee ../deploy.log
cd ..

export TIMESTAMP=`date +%Y-%m-%d-%H%M%S`

export NEW_CONTRACT=`grep -A999 "Starting migrations" deploy.log | grep -A4 "'FranklinProxy'" | grep "contract address" | grep -oE '0x(.+)' \
| sed -n "s/0x//p"`

if [ ! -z "$NEW_CONTRACT" ]
then
    echo New contract at $NEW_CONTRACT

    OLD_CONTRACT=`grep CONTRACT_ADDR ./$ENV_FILE | grep -oE '=(.+)' | sed -n "s/=//p"`
    echo Old contract at $OLD_CONTRACT

    mkdir -p logs/$TIMESTAMP/
    cp ../deploy.log logs/$TIMESTAMP/deploy.log
    cp $ENV_FILE logs/$TIMESTAMP/

    sed -i".bak" "s/CONTRACT_ADDR=$OLD_CONTRACT/CONTRACT_ADDR=$NEW_CONTRACT/g" ./$ENV_FILE

else
    echo "Contract deployment failed"
    exit 1
fi
