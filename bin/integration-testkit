#!/bin/bash
. .setup_env

set -e

trap clean_up EXIT

PREV_WEB3_URL=$WEB3_URL

function clean_up() {
    exitcode=$?
    docker kill $CONTAINER_ID > /dev/null || echo "no container to kill"
    export WEB3_URL=$PREV_WEB3_URL
    exit $exitcode
}

# run with usual geth
cargo run --bin exodus_test --release

if [[ $ZKSYNC_ENV == ci ]]; then
    export WEB3_URL=http://ganache:7545
else
    CONTAINER_ID=$(docker run -d -p 7545:7545 matterlabs/ganache)
    export WEB3_URL=http://localhost:7545
    echo $CONTAINER_ID
fi

cargo run --bin testkit --release
cargo run --bin migration_test --release
